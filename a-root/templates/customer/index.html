{% extends 'dashboard.html' %}

{% block header %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <h1 class="h3 mb-4 text-gray-800">{{ customer.name }}</h1>
    <div class="row">
        <div class="col-lg-12">
            <!-- Circle Buttons -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{{ customer.wordpress_url }}</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-4">
                            {% if not customer.facebook_token %}
                            <button id="facebook_btn" style="font-size:1.8rem; width: 100%; height: 10rem;" type="button" class="insta btn btn-facebook">Facebook</button>
                            {% else %}
                            <button id="facebook_btn" style="font-size:1.8rem; width: 100%; height: 10rem;" type="button" class="insta btn btn-facebook" disabled>Facebook連携済<br><span style="font-size: 1.2rem">{{ customer.start_date }} UTC</span></button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-12">
            <div class="card-header pt-3">
                <h6 class="m-0 font-weight-bold text-primary">instagram-wordpress 連携状況{% if customer.facebook_token %}<button id="facebook_execute" class="mx-2 btn btn-sm btn-danger">連携実行</button>{% endif %}</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                  <thead class="thead-light">
                    <tr>
                      <th scope="col">連携日時</th>
                      <th scope="col">InstagramURL</th>
                      <th scope="col">WordpressURL</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for post in posts %}
                    <tr>
                      <th scope="row">{{ post["created_at"] }}</th>
                      <td>
                          <a href="{{ post['permalink'] }}" target="_blank">{{ post["permalink"][0:35] }}...</a>
                      </td>
                      <td>
                          <a href="{{ post['wordpress_link'] }}" target="_blank">{{ post["wordpress_link"][0:35] }}...</a>
                      </td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal" tabindex="-1" role="dialog" id="dataModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Instagram</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div id="modal-body" class="modal-body">
        <p>モーダルボディ</p>
      </div>
      <div class="modal-footer">
        <button id="execute_post_wordpress" type="button" class="btn btn-primary" data-dismiss="modal">連携</button>
      </div>
    </div>
  </div>
</div>

<link href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css" rel="stylesheet">
<!-- BootstrapのJavaScript Bundle（Popperが含まれています） -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.bundle.min.js"></script>


<script>
    function getCardGrop(data) {
        let html = "";
        let ary = Array.from(data);
        if (ary.length > 0) {
            document.getElementById("execute_post_wordpress").disabled = false;
            html += "<p>以下の投稿をWordpressに連携します。問題なければ下部の「連携」ボタンを押してください。</p>"
            ary.forEach((m) => {
                html += `<div class="card m-3">
                    <img class="bd-placeholder-img card-img-top" src="${m['media_url']}" class="img-fluid" alt="Responsive image">
                    <div class="card-body"><p class="card-text">${m['caption'].replaceAll("\n", "<br>")}</p></div>
                  </div>`;
            });
        } else {
            document.getElementById("execute_post_wordpress").disabled = true;
            html += "<p>対象データはありません。</p>";
        }

        return html;
    }
    let instagramPost = null;
    document.getElementById("facebook_btn").addEventListener("click", (event) => {
        document.getElementById("facebook_btn").disabled = true;
        FB.login(function(response){
            console.log(response);
            if (response.status === "connected") {
                const accessToken = response.authResponse.accessToken;
                post("/facebook/auth", {accessToken})
            } else {
                document.getElementById("facebook_btn").disabled = false;
            }
        }, {scope: 'public_profile, pages_show_list, business_management, instagram_basic'});
    })
    let facebook_btn = document.getElementById("facebook_execute");
    if (facebook_btn) {
        facebook_btn.addEventListener("click", (event) => {
            if (!window.confirm("Instagramの投稿を取得しますか？")) {
                return;
            }
            showLoadingOverlay();
            fetch("/instagram", {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: null
            })
            .then(response => response.json())
            .then(data => {
                instagramPost = data;
                let modalElement = document.getElementById('dataModal');
                let modalInstance = new bootstrap.Modal(modalElement);
                document.getElementById("modal-body").innerHTML = getCardGrop(data);
                modalInstance.show();
            })
            .catch((error) => {
                console.error('エラー発生:', error);
            })
            .finally(() => {
                hideLoadingOverlay();
            });
        })
    }
    let execute_btn = document.getElementById("execute_post_wordpress");
    if (execute_btn) {
        execute_btn.addEventListener("click", (event) => {
            postToWordpress();
        });
    }
    function postToWordpress() {
        showLoadingOverlay();
        if (instagramPost) {
            fetch("/post/wordpress", {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(instagramPost)
            })
            .then(response => response.json())
            .then(data => {
                window.alert("連携が完了しました。");
                window.location.reload();
            })
            .catch((error) => {
                console.error('エラー発生:', error);
            })
            .finally(() => {
                hideLoadingOverlay();
            });
        }
    }

</script>

{% endblock %}

